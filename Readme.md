# Kafka Streams Messaging Simulation System

Распределенная система потоковой обработки данных для симуляции мессенджера с функциями динамической модерации.  
Фильтрует сообщения от заблокированных пользователей, цензурит запрещенные слова и обогащает данные логинами пользователей.

 **Команда для запуска:** `docker compose up -d --build`

> **Важно:** Система развернута на KRaft-кластере (3 брокера), все топики создаются автоматически сервисом initializer. 
>
> | Топик | Назначение | Партиции | Репликация | Очистка | Топология |
> | :--- | :--- | :---: | :---: | :---: | :---: |
> | **raw_message** | Входящий поток | 3 | 2 | delete | kstream  |
> | **ban** | Блокировки | 3 | 2 | delete | ktable |
> | **message** | Финальный поток | 3 | 2 | delete | kstream |
> | **prohibited_word** | Запрещенные слова | 1 | 2 | compact | globalktable |
> | **user** | Пользователи | 1 | 2 | compact | globalktable |

## Компоненты системы

1. **SimulationInitializer** (сервис инициализации)
    * Гарантирует создание топиков перед запуском основной логики.
    * Настраивает политику `compact` для справочников, обеспечивая постоянное хранение данных пользователей и запрещенных слов.

2. **SimulationProducer** (симулятор активности)
    * Генерирует поток сообщений и события блокировки/разблокировки пользователей.
    * Использует идемпотентность и уровень подтверждения `acks=all` для гарантии доставки.

3. **SimulationTopology** (конвейер обработки)
    * Фильтрация: Удаляет сообщения от отправителей, находящихся в черном списке у получателя.
    * Динамическая модерация: Проверяет каждое слово в сообщении и заменяет запрещенные слова на `***`.
    * Обогащение: Подставляет из справочника актуальные логины отправителя и получателя.

4. **SimulationMonitor** (визуализатор симуляции)
    * Служит «глазами» системы: выводит в консоль все попытки отправки и все изменения в списках блокировок.
    * Подтверждает работу фильтров: выводит текст сообщения с цензурой только в том случае, если оно успешно прошло проверку блокировки отправителя.

## Принцип работы

1. **Запуск**: инициализатор создаёт инфраструктуру топиков, настраивает справочные топики пользователей и запрещенных слов на хранение последних значений.
2. **Наполнение**: продюсер заполняет справочники `user-store` и `prohibited-word-store`, после чего переходит к имитации активности пользователей.
3. **Обработка**:
    - продюсер отправляет сообщение в топик `raw_message`, выбрав случайным образом идентификатор отправителя, идентификатор получателя и текст сообщения.
    - топология подхватывает сообщение, проверяет его по таблице блокировок `ban-store` и пропускает дальше, если получатель не блокировал отправителя.
    - сообщение проходит через цензор, где запрещенные слова маскируются по справочнику `prohibited-word-store`.
    - финальный процессор обогащает сообщение логинами отправителя и получателя, используя справочник `user-store`, после чего отправляет его в топик `message`.
4. **Контроль**: монитор разделяет попытки и результат: видны все входящие запросы и блокировки, но сообщения отображаются только в случае успешной доставки.
5. **Завершение**: все компоненты поддерживают **Graceful Shutdown**, корректно закрывая соединения и транзакции при остановке контейнеров.

## Проверка и мониторинг

1. **Веб-интерфейс Kafka UI** ([http://localhost:8080](http://localhost:8080))
    *   **Топики:** визуальный контроль за прохождением сообщений через фильтры.
    *   **Локальные хранилища:** мониторинг наполнения RocksDB (баны, пользователи).
2. **Логи реального времени**
    * `docker compose logs -f producer` — генерация сообщений и событий блокировок.
    * `docker compose logs -f monitor` — итоговая лента «чистых» сообщений.

## Стек технологий (2026)

| Категория | Технология |
| :--- | :--- |
| **Runtime** | Java 21 LTS (Eclipse Temurin) |
| **Infrastructure** | Kafka 3.4 (KRaft-кластер из трех узлов) |
| **Processing** | 	Kafka Streams API (Exactly Once V2) |
| **Orchestration** | Docker Compose + Healthchecks |
| **Monitoring** | [Kafka UI (порт 8080)](http://localhost:8080) |
| **Build** | Maven (Shade Plugin, Services Transformer) |
| **Logging** | SLF4J + Logback |

## Переменные окружения

1. **Общие**
    * `BOOTSTRAP_SERVERS` — список адресов брокеров кластера.
    * `REPLICATION_FACTOR` — количество реплик для каждого топика.
    * `REQUEST_TIMEOUT_MS` — общий таймаут ожидания ответа от брокера.
    * `PARTITIONS_COUNT` — число партиций для основных потоков данных.
    * `GLOBAL_PARTITIONS_COUNT` — число партиций для справочников.
    * `GRACEFUL_SHUTDOWN_WAIT_MS` — время ожидания корректного закрытия ресурсов при выходе из приложения.

2. **Топики**
    * `TOPIC_PROHIBITED_WORD` — запрещенные слова.
    * `TOPIC_RAW_MESSAGE` — входящий поток сообщений.
    * `TOPIC_MESSAGE` — финальный поток сообщений.
    * `TOPIC_USER` — пользователи.
    * `TOPIC_BAN` — бан.

3. **Хранилища**
    * `STORE_PROHIBITED_WORD` — запрещенные слова.
    * `STORE_USER` — пользователи.
    * `STORE_BAN` — бан.

4. **Сервис инициализации**
    * `INITIALIZER_RECONNECT_BACKOFF_MS` — пауза между попытками переподключения к брокерам при старте.
    * `INITIALIZER_RETRIES_CONFIG` — максимальное количество попыток создания топиков при сбоях.
    * `INITIALIZER_CLIENT_ID` — имя клиента инициализатора для логов Kafka.

5. **Симулятор активности**
    * `PRODUCER_SIMULATION_CYCLE_MAX_WAIT_MS` — максимальная пауза между циклами генерации случайных событий в симуляции.
    * `PRODUCER_DELIVERY_TIMEOUT_MS` — максимальное время на доставку сообщения (включая ретраи).
    * `PRODUCER_BATCH_SIZE_BYTES` — максимальный размер пачки сообщений перед отправкой в Kafka.
    * `PRODUCER_LINGER_MS` — время ожидания для накопления пачки перед принудительной отправкой.
    * `PRODUCER_RETRY_BACKOFF_MS` — пауза перед повторной попыткой отправки сообщения.

6. **Конвейер обработки**
    * `TOPOLOGY_STATESTORE_CACHE_MAX_KB` — максимальный объем оперативной памяти для кэширования состояний RocksDB.
    * `TOPOLOGY_APPLICATION_ID` — уникальный идентификатор приложения, использующийся для хранения состояния и в качестве имени группы потребителей.
    * `TOPOLOGY_PROHIBITED_MASK` — строка, которой будут заменяться запрещенные слова.
    * `TOPOLOGY_UNKNOWN_LOGIN_MASK` — заглушка, если в справочнике не найден логин пользователя по его ID.

7. **Визуализатор симуляции**
    * `MONITOR_AUTO_COMMIT_INTERVAL_MS` — интервал автоматического подтверждения прочитанных сообщений (offsets).
    * `MONITOR_POLL_MS` — частота опроса Kafka на наличие новых сообщений.
    * `MONITOR_FETCH_MIN_BYTES` — минимальный объем данных, который брокер должен собрать перед ответом консумеру.
    * `MONITOR_FETCH_MAX_WAIT_MS` — максимальное время ожидания брокером накопления минимального объема данных (MONITOR_FETCH_MIN_BYTES).
    * `MONITOR_SESSION_TIMEOUT_MS` — время, по истечении которого брокер сочтет монитор «мертвым» и исключит из группы.
    * `MONITOR_HEARTBEAT_INTERVAL_MS` — частота отправки «сигналов жизни» брокеру (heartbeats), должна быть в 3 раза меньше сессии.
    * `MONITOR_REQUEST_TIMEOUT_MS` — таймаут сетевого запроса монитора, должен быть больше MONITOR_FETCH_MAX_WAIT_MS + время обработки запроса.
    * `MONITOR_GROUP_ID` — имя группы потребителей для монитора.
    * `MONITOR_GROUP_ID_USE_MS_POSTFIX` — флаг временного постфикса в имени группы, при установке **true** монитор будет всегда создавать новую группу и читать историю с начала.
